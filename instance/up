#!/bin/bash

. lib/update_env
. .env

if [ "$PHILA_INSTANCE" ]; then
  echo "Existing reference found: PHILA_INSTANCE=$PHILA_INSTANCE"
  read -p "Spin up new instance and replace reference? (Enter \"y\" to proceed.) " ref_replace
  [ ! "$ref_replace" = "y" ] && exit 0
fi

user_data="file://instance/user-data.sh"
[ "$PHILA_ENV" = "prod" ] && user_data="file://instance/user-data-prod.sh"

echo "Provisioning instance."
PHILA_INSTANCE=`aws ec2 run-instances --user-data $user_data --key-name $KEY_PAIR_NAME \
--instance-type t2.micro --associate-public-ip-address --image-id $AMI --subnet-id $SUBNET | \
grep '^INSTANCES' | cut -f8`

echo "Tagging instance."
aws ec2 create-tags --resources $PHILA_INSTANCE --tags Key=Name,Value=phila.gov-test

update_env 'PHILA_INSTANCE' $PHILA_INSTANCE

instance/prep
