var wp,wpAjax,ajaxurl,jQuery,_,getUserSetting,setUserSetting,deleteUserSetting,mlaTaxonomy,mlaModal={strings:{},settings:{},initialHTML:{},uploading:false,cid:null,utility:{originalMediaAjax:null,mlaAttachmentsBrowser:null,parseTermsOptions:null,arrayCleanup:null,parseTaxonomyId:null,hookCompatTaxonomies:null,fillCompatTaxonomies:null,supportCompatTaxonomies:null},tagBox:null};(function(b){var a=wp.media.view.AttachmentsBrowser;mlaModal.strings=typeof wp.media.view.l10n.mla_strings==="undefined"?{}:wp.media.view.l10n.mla_strings;delete wp.media.view.l10n.mla_strings;mlaModal.settings=typeof wp.media.view.settings.mla_settings==="undefined"?{screen:"unknown",enableMediaGrid:false,enableMediaModal:false}:wp.media.view.settings.mla_settings;delete wp.media.view.settings.mla_settings;if(!(mlaModal.settings.enableMediaGrid||mlaModal.settings.enableMediaModal)){return}if(("grid"===mlaModal.settings.screen)&&false===mlaModal.settings.enableMediaGrid){return}if(("modal"===mlaModal.settings.screen)&&false===mlaModal.settings.enableMediaModal){return}mlaModal.utility.originalMediaAjax=wp.media.ajax;wp.media.ajax=function(i,e){var h=mlaModal.settings.state,g,d,f,c;if(_.isObject(i)){e=i}else{e=e||{};e.data=_.extend(e.data||{},{action:i})}if("query-attachments"==e.data.action){g=e.data.query;d=typeof g.s;if("object"==d){f=g.s}else{if("string"==d){f={mla_search_value:g.s}}else{f={mla_search_value:""}}}if("undefined"!=typeof g.post_mime_type){mlaModal.settings.query[h].filterMime=g.post_mime_type}else{mlaModal.settings.query[h].filterMime="all"}if("undefined"!=typeof f.mla_filter_month){mlaModal.settings.query[h].filterMonth=f.mla_filter_month}else{if("undefined"!=typeof g.year){mlaModal.settings.query[h].filterMonth=(100*g.year)+(1*g.monthnum)}else{}}if("undefined"!=typeof f.mla_filter_term){mlaModal.settings.query[h].filterTerm=f.mla_filter_term}if("undefined"!=typeof f.mla_search_value){mlaModal.settings.query[h].searchValue=f.mla_search_value}c={mla_filter_month:mlaModal.settings.query[h].filterMonth,mla_filter_term:mlaModal.settings.query[h].filterTerm,mla_terms_search:mlaModal.settings.query[h].termsSearch,mla_search_clicks:mlaModal.settings.query[h].searchClicks,mla_search_value:mlaModal.settings.query[h].searchValue,mla_search_fields:mlaModal.settings.query[h].searchFields,mla_search_connector:mlaModal.settings.query[h].searchConnector};mlaModal.settings.query[h].termsSearch="";b("#mla-terms-search-input").html("").val("");e.data.query.s=c}return mlaModal.utility.originalMediaAjax.call(this,e)};if(mlaModal.settings.enableMimeTypes){wp.media.view.AttachmentFilters.Mla=wp.media.view.AttachmentFilters.extend({createFilters:function(){var d=this.controller._state,c={};_.each(mlaModal.settings.allMimeTypes||{},function(f,e){if(("grid"===mlaModal.settings.screen)||("trash"!==e)){c[e]={text:f,props:{type:e,uploadedTo:null,orderby:"date",order:"DESC"}}}});c.all={text:wp.media.view.l10n.allMediaItems,props:{type:null,uploadedTo:null,orderby:"date",order:"DESC"},priority:10};if(wp.media.view.settings.post.id){c.uploaded={text:wp.media.view.l10n.uploadedToThisPost,props:{type:null,uploadedTo:wp.media.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20}}this.filters=c;if("undefined"===typeof c[mlaModal.settings.query[d].filterMime]){mlaModal.settings.query[d].filterMime="all"}if(mlaModal.settings.query[d].filterMime!="all"){this.model.set(c[mlaModal.settings.query[d].filterMime].props,{silent:false})}},select:function(){var f=this.controller._state,c=this.model,e=mlaModal.settings.query[f].filterMime,d=c.toJSON();if(false===mlaModal.settings.enableSearchBox){if("string"==typeof d.search){mlaModal.settings.query[f].searchValue=d.search}else{mlaModal.settings.query[f].searchValue=""}}_.find(this.filters,function(h,i){var g=_.all(h.props,function(k,j){return k===(_.isUndefined(d[j])?null:d[j])});if(g){return e=i}});this.$el.val(e)},change:function(){var d=b(this.el).closest("div.media-toolbar"),c=this.filters[this.el.value];if(c){this.model.set(c.props,{silent:true});b("#mla-search-submit",d).click()}}});wp.media.view.AttachmentFilters.MlaUploaded=wp.media.view.AttachmentFilters.extend({createFilters:function(){var d=this.model.get("type"),c=wp.media.view.settings.mimeTypes,g,f=this.controller._state,e={};if(c&&d){g=c[d]}_.each(mlaModal.settings.uploadMimeTypes||{},function(i,h){if(("grid"===mlaModal.settings.screen)||("trash"!==h)){e[h]={text:i,props:{type:h,uploadedTo:null,orderby:"date",order:"DESC"}}}});e.all={text:g||wp.media.view.l10n.allMediaItems,props:{uploadedTo:null,orderby:"date",order:"DESC"},priority:10};e.uploaded={text:wp.media.view.l10n.uploadedToThisPost,props:{type:null,uploadedTo:wp.media.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20};e.unattached={text:wp.media.view.l10n.unattached,props:{uploadedTo:0,orderby:"menuOrder",order:"ASC"},priority:50};this.filters=e;if("undefined"===typeof e[mlaModal.settings.query[f].filterUploaded]){mlaModal.settings.query[f].filterUploaded="all"}if(mlaModal.settings.query[f].filterUploaded!="all"){this.model.set(e[mlaModal.settings.query[f].filterUploaded].props,{silent:false})}},select:function(){var f=this.controller._state,c=this.model,e=mlaModal.settings.query[f].filterMime,d=c.toJSON();if(false===mlaModal.settings.enableSearchBox){if("string"==typeof d.search){mlaModal.settings.query[f].searchValue=d.search}else{mlaModal.settings.query[f].searchValue=""}}_.find(this.filters,function(h,i){var g=_.all(h.props,function(k,j){return k===(_.isUndefined(d[j])?null:d[j])});if(g){return e=i}});this.$el.val(e)},change:function(){var d=b(this.el).closest("div.media-toolbar"),c=this.filters[this.el.value];if(c){this.model.set(c.props,{silent:true});b("#mla-search-submit",d).click()}}})}if(mlaModal.settings.enableMonthsDropdown){wp.media.view.AttachmentFilters.MlaMonths=wp.media.view.AttachmentFilters.extend({className:"attachment-filters",id:"media-attachment-date-filters",createFilters:function(){var d=this.controller._state,c={};_.each(mlaModal.settings.months||{},function(f,e){c[e]={text:f,props:{s:{mla_filter_month:e}}}});this.filters=c;if("undefined"===typeof c[mlaModal.settings.query[d].filterMonth]){mlaModal.settings.query[d].filterMonth=0}if(mlaModal.settings.query[d].filterMonth>0){this.model.set(c[mlaModal.settings.query[d].filterMonth].props,{silent:false})}},select:function(){var f=this.controller._state,c=this.model,e=mlaModal.settings.query[f].filterMonth,d=c.toJSON();if(_.isUndefined(d.s)){d.s={}}if(false===mlaModal.settings.enableSearchBox){if("string"==typeof d.search){mlaModal.settings.query[f].searchValue=d.search}else{mlaModal.settings.query[f].searchValue=""}}if(_.isUndefined(d.s.mla_filter_month)){d.s.mla_filter_month=mlaModal.settings.query[f].filterMonth}else{mlaModal.settings.query[f].filterMonth=d.s.mla_filter_month}_.find(this.filters,function(h,i){var g=_.all(h.props,function(j){return j.mla_filter_month==mlaModal.settings.query[f].filterMonth});if(g){return e=i}});this.$el.val(e)},change:function(){var c=this.filters[this.el.value],d;if(c){d={s:{mla_filter_month:c.props.s.mla_filter_month}};this.model.set(d)}}})}if(mlaModal.settings.enableTermsDropdown){wp.media.view.AttachmentFilters.MlaTerms=wp.media.view.AttachmentFilters.extend({className:"attachment-filters",id:"media-attachment-term-filters",createFilters:function(){var e=this.controller._state,c,d={};_.each(mlaModal.settings.termsText||{},function(g,f){d[f]={text:g,props:{s:{mla_filter_term:parseInt(mlaModal.settings.termsValue[f])}}}});this.filters=d;c=_.indexOf(mlaModal.settings.termsValue,mlaModal.settings.query[e].filterTerm);if(c>0){this.model.set(d[c].props,{silent:false})}},select:function(){var f=this.controller._state,c=this.model,e=mlaModal.settings.query[f].filterTerm,d=c.toJSON();if(_.isUndefined(d.s)){d.s={}}if(false===mlaModal.settings.enableSearchBox){if("string"==typeof d.search){mlaModal.settings.query[f].searchValue=d.search}else{mlaModal.settings.query[f].searchValue=""}}if(_.isUndefined(d.s.mla_filter_term)){d.s.mla_filter_term=mlaModal.settings.query[f].filterTerm}else{mlaModal.settings.query[f].filterTerm=d.s.mla_filter_term}_.find(this.filters,function(h,i){var g=_.all(h.props,function(j){return j.mla_filter_term==mlaModal.settings.query[f].filterTerm});if(g){return e=i}});this.$el.val(e)},change:function(){var c=this.filters[this.el.value],d;if(c){d={s:{mla_filter_term:c.props.s.mla_filter_term}};this.model.set(d)}}})}if(mlaModal.settings.enableTermsSearch){wp.media.view.MlaTermsSearch=wp.media.View.extend({tagName:"span",className:"mla-terms-search",template:wp.media.template("mla-terms-search-button"),attributes:{type:"mla-terms-search-button"},events:{change:"termsSearchOpen",click:"termsSearchOpen",},render:function(){this.$el.html(this.template(mlaModal.strings));return this},termsSearchOpen:function(d){var c=b(this.el).closest("div.media-toolbar");if(("click"==d.type)&&("mla_terms_search"===d.target.name)){mlaTaxonomy.termsSearch.open();b("#mla-terms-search-form").off("submit");b("#mla-terms-search-form").submit(function(i){var f,h,g={phrases:"",taxonomies:[]};i.preventDefault();f=b("#mla-terms-search-form").serializeArray();for(h=0;h<f.length;h++){switch(f[h].name){case"mla_terms_search[phrases]":g.phrases=f[h].value;break;case"mla_terms_search[radio_phrases]":g.radio_phrases=f[h].value;break;case"mla_terms_search[radio_terms]":g.radio_terms=f[h].value;break;case"mla_terms_search[taxonomies][]":g.taxonomies[g.taxonomies.length]=f[h].value;break}}mlaModal.settings.query[mlaModal.settings.state].termsSearch=g;b("#mla-search-submit",c).click();return false});b("#mla-terms-search-input").keypress(function(f){if(13==f.which){f.preventDefault();b("#mla-terms-search-submit").click()}})}}})}if(mlaModal.settings.enableSearchBox){wp.media.view.MlaSearch=wp.media.View.extend({tagName:"div",className:"mla-search-box",template:wp.media.template("mla-search-box"),attributes:{type:"mla-search-box"},events:{input:"search",change:"search",click:"search",search:"search",MlaSearch:"search"},initialize:function(){var c=this.controller._state;if("undefined"===typeof mlaModal.settings.query[c]){mlaModal.settings.query[c]=_.clone(mlaModal.settings.query.initial);mlaModal.settings.query[c].searchFields=_.clone(mlaModal.settings.query.initial.searchFields)}},render:function(){var d=this.controller._state,c=_.extend(mlaModal.strings,mlaModal.settings.query[d]);this.$el.html(this.template(c));return this},search:function(e){var f=this.controller._state,c,g,d;if(("input"==e.type)&&("s[mla_search_value]"==e.target.name)){mlaModal.settings.query[f].searchValue=e.target.value;return}if(("click"==e.type)&&("mla_search_submit"!=e.target.name)){return}switch(e.target.name){case"s[mla_search_value]":mlaModal.settings.query[f].searchValue=e.target.value;break;case"mla_search_submit":c={mla_filter_month:mlaModal.settings.query[f].filterMonth,mla_filter_term:mlaModal.settings.query[f].filterTerm,mla_terms_search:mlaModal.settings.query[f].termsSearch,mla_search_clicks:mlaModal.settings.query[f].searchClicks++,mla_search_value:mlaModal.settings.query[f].searchValue,mla_search_fields:mlaModal.settings.query[f].searchFields,mla_search_connector:mlaModal.settings.query[f].searchConnector};this.model.set({s:c});break;case"s[mla_search_connector]":mlaModal.settings.query[f].searchConnector=e.target.value;break;case"s[mla_search_title]":g=mlaModal.settings.query[f].searchFields;d=g.indexOf("title");if(-1==d){g.push("title")}else{g.splice(d,1)}mlaModal.settings.query[f].searchFields=g;break;case"s[mla_search_name]":d=mlaModal.settings.query[f].searchFields.indexOf("name");if(-1==d){mlaModal.settings.query[f].searchFields.push("name")}else{mlaModal.settings.query[f].searchFields.splice(d,1)}break;case"s[mla_search_alt_text]":d=mlaModal.settings.query[f].searchFields.indexOf("alt-text");if(-1==d){mlaModal.settings.query[f].searchFields.push("alt-text")}else{mlaModal.settings.query[f].searchFields.splice(d,1)}break;case"s[mla_search_excerpt]":d=mlaModal.settings.query[f].searchFields.indexOf("excerpt");if(-1==d){mlaModal.settings.query[f].searchFields.push("excerpt")}else{mlaModal.settings.query[f].searchFields.splice(d,1)}break;case"s[mla_search_content]":d=mlaModal.settings.query[f].searchFields.indexOf("content");if(-1==d){mlaModal.settings.query[f].searchFields.push("content")}else{mlaModal.settings.query[f].searchFields.splice(d,1)}break;case"s[mla_search_terms]":d=mlaModal.settings.query[f].searchFields.indexOf("terms");if(-1==d){mlaModal.settings.query[f].searchFields.push("terms")}else{mlaModal.settings.query[f].searchFields.splice(d,1)}break}}})}else{wp.media.view.MlaSearch=wp.media.View.extend({tagName:"span",className:"mla-simulate-search-button",template:wp.media.template("mla-simulate-search-button"),attributes:{type:"mla-simulate-search-button"},events:{click:"simulateSearch",},render:function(){this.$el.html(this.template(mlaModal.strings));return this},simulateSearch:function(){var d=this.controller._state,c={mla_filter_month:mlaModal.settings.query[d].filterMonth,mla_filter_term:mlaModal.settings.query[d].filterTerm,mla_terms_search:mlaModal.settings.query[d].termsSearch,mla_search_clicks:mlaModal.settings.query[d].searchClicks++,mla_search_value:mlaModal.settings.query[d].searchValue,mla_search_fields:mlaModal.settings.query[d].searchFields,mla_search_connector:mlaModal.settings.query[d].searchConnector};this.model.set({s:c})}})}if(mlaModal.settings.enableMimeTypes||mlaModal.settings.enableMonthsDropdown||mlaModal.settings.enableTermsDropdown||mlaModal.settings.enableTermsSearch||mlaModal.settings.enableSearchBox){wp.media.view.AttachmentsBrowser=wp.media.view.AttachmentsBrowser.extend({createToolbar:function(){var c,d=this.controller._state;mlaModal.settings.state=d;mlaModal.settings.$el=this.controller.$el;if("undefined"===typeof mlaModal.settings.query[d]){mlaModal.settings.query[d]=_.clone(mlaModal.settings.query.initial);mlaModal.settings.query[d].searchFields=_.clone(mlaModal.settings.query.initial.searchFields)}a.prototype.createToolbar.apply(this,arguments);mlaModal.utility.mlaAttachmentsBrowser=this;c=this.options.filters;if(typeof window.eml!=="undefined"){b(".media-toolbar",this.$el).css("overflow","hidden")}if(("all"===c)&&mlaModal.settings.enableMimeTypes){this.toolbar.unset("filters",{silent:true});this.toolbar.set("filters",new wp.media.view.AttachmentFilters.Mla({controller:this.controller,model:this.collection.props,priority:-80}).render())}if(("uploaded"===c)&&mlaModal.settings.enableMimeTypes){this.toolbar.unset("filters",{silent:true});this.toolbar.set("filters",new wp.media.view.AttachmentFilters.MlaUploaded({controller:this.controller,model:this.collection.props,priority:-80}).render())}if(this.options.search&&mlaModal.settings.enableMonthsDropdown){this.toolbar.unset("dateFilter",{silent:true});this.toolbar.set("dateFilter",new wp.media.view.AttachmentFilters.MlaMonths({controller:this.controller,model:this.collection.props,priority:-75}).render())}if(this.options.search&&mlaModal.settings.enableTermsDropdown){this.toolbar.set("terms",new wp.media.view.AttachmentFilters.MlaTerms({controller:this.controller,model:this.collection.props,priority:-50}).render())}if(this.options.search&&mlaModal.settings.enableTermsSearch){this.toolbar.set("termsSearch",new wp.media.view.MlaTermsSearch({controller:this.controller,model:this.collection.props,priority:-50}).render())}if(this.options.search){if(mlaModal.settings.enableSearchBox){this.controller.on("content:activate",this.hideDefaultSearch);this.controller.on("router:render",this.hideDefaultSearch);this.controller.on("uploader:ready",this.hideDefaultSearch);this.controller.on("edit:activate",this.hideDefaultSearch);this.toolbar.set("MlaSearch",new wp.media.view.MlaSearch({controller:this.controller,model:this.collection.props,priority:60}).render())}else{this.toolbar.set("MlaSearch",new wp.media.view.MlaSearch({controller:this.controller,model:this.collection.props,priority:70}).render())}}},hideDefaultSearch:function(){var c=b("#media-search-input",this.el);if(0===c.length){c=b("div.media-toolbar-primary > input.search",this.el)}c.hide()},updateFilters:function(c,d){var e={};if(this.options.search&&mlaModal.settings.enableTermsDropdown&&mlaModal.settings.termsTaxonomy==c){e=mlaModal.utility.parseTermsOptions(d);mlaModal.settings.termsClass=e.termsClass;mlaModal.settings.termsText=e.termsText;mlaModal.settings.termsValue=e.termsValue;this.toolbar.unset("terms",{silent:true});this.toolbar.set("terms",new wp.media.view.AttachmentFilters.MlaTerms({controller:this.controller,model:this.collection.props,priority:-80}).render())}}})}mlaModal.utility.parseTermsOptions=function(i){var h={termsClass:[mlaModal.settings.termsClass[0],mlaModal.settings.termsClass[1]],termsText:[mlaModal.settings.termsText[0],mlaModal.settings.termsText[1]],termsValue:[mlaModal.settings.termsValue[0],mlaModal.settings.termsValue[1]]},e=2,c,d,g=/\<option(( class=\"([^\"]+)\" )|( ))value=((\'([^\']+)\')|(\"([^\"]+)\"))([^\>]*)\>([^\<]*)\<.*/g,f=[];if("object"===typeof i){e=mlaModal.settings.termsValue.length;for(c=2;c<e;c++){f[c]={termsClass:mlaModal.settings.termsClass[c],termsText:mlaModal.settings.termsText[c],termsValue:mlaModal.settings.termsValue[c]};if("undefined"!==typeof i[mlaModal.settings.termsValue[c]]){delete i[mlaModal.settings.termsValue[c]]}}for(d in i){f[c++]={termsClass:"level-0",termsText:i[d],termsValue:d.toString()}}if(e===c){return{termsClass:mlaModal.settings.termsClass,termsText:mlaModal.settings.termsText,termsValue:mlaModal.settings.termsValue}}f.sort(function(k,j){if(k.termsText>j.termsText){return 1}else{if(k.termsText<j.termsText){return -1}else{return 0}}});c=2;for(d in f){h.termsClass[c]=f[d].termsClass;h.termsText[c]=f[d].termsText;h.termsValue[c++]=f[d].termsValue}return h}f=g.exec(i);while(null!==(f=g.exec(i))){h.termsClass[e]=f[3];h.termsValue[e]=("undefined"===typeof f[6])?f[9]:f[7];h.termsText[e++]=f[11].replace("&nbsp;",mlaModal.settings.termsIndent)}return h};mlaModal.utility.arrayCleanup=function(e){var d=[],c=("string"===typeof e);if(c){e=e.split(mlaModal.settings.comma)}jQuery.each(e,function(f,g){g=jQuery.trim(g);if(g&&jQuery.inArray(g,d)==-1){d.push(g)}});d.sort();if(c){d=d.join(mlaModal.settings.comma)}return d};mlaModal.utility.parseTaxonomyId=function(d){var c=d.split("-");c.shift();c.shift();return c.join("-")};mlaModal.tagBox={cleanTags:function(d){var c=mlaModal.settings.comma;if(","!==c){d=d.replace(new RegExp(c,"g"),",")}d=d.replace(/\s*,\s*/g,",").replace(/,+/g,",").replace(/[,\s]+$/,"").replace(/^[,\s]+/,"");if(","!==c){d=d.replace(/,/g,c)}return d},parseTags:function(f){var j=f.id,d=j.split("-check-num-")[1],g=b(f).closest(".tagsdiv"),i=g.find(".the-tags"),c=mlaModal.settings.comma,e=i.val().split(c),h=[];delete e[d];b.each(e,function(k,l){l=b.trim(l);if(l){h.push(l)}});i.val(this.cleanTags(h.join(c)));this.quickClicks(g);return false},quickClicks:function(e){var h=b(".the-tags",e),f=b(".tagchecklist",e),g=b(e).attr("id"),c,d;if(!h.length){return}d=h.prop("disabled");c=h.val().split(mlaModal.settings.comma);f.empty();b.each(c,function(j,l){var k,i;l=b.trim(l);if(!l){return}k=b("<span />").text(l);if(!d){i=b('<a id="'+g+"-check-num-"+j+'" class="ntdelbutton">X</a>');i.click(function(){mlaModal.tagBox.parseTags(this)});k.prepend("&nbsp;").prepend(i)}f.append(k)})},flushTags:function(i,e,d){var k,c,g,l=b(".the-tags",i),h=b("input.newtag",i),j=mlaModal.settings.comma;e=e||false;g=e?b(e).text():h.val();k=l.val();c=k?k+j+g:g;c=mlaModal.utility.arrayCleanup(this.cleanTags(c));l.val(c);this.quickClicks(i);if(!e){h.val("")}if("undefined"==typeof(d)){h.focus()}return false},getCloud:function(d,c){b.post(ajaxurl,{action:"get-tagcloud",tax:c},function(f,e){if(0===f||"success"!=e){f=wpAjax.broken}f=b('<p id="tagcloud-'+c+'" class="the-tagcloud">'+f+"</p>");b("a",f).click(function(){mlaModal.tagBox.flushTags(b(this).closest(".mla-taxonomy-field").children(".tagsdiv"),this);return false});b("#"+d).after(f)})},init:function(g,c,e){var f,d;f=b("#mla-taxonomy-"+c,e);d=b("div.ajaxtag",f);mlaModal.tagBox.quickClicks(f);b("input.tagadd",d).click(function(){mlaModal.tagBox.flushTags(b(this).closest(".tagsdiv"))});b("input.newtag",d).keyup(function(h){if(13==h.which){mlaModal.tagBox.flushTags(f);return false}}).keypress(function(h){if(13==h.which){h.preventDefault();return false}}).each(function(){b(this).suggest(ajaxurl+"?action=ajax-tag-search&tax="+c,{delay:500,resultsClass:"mla_ac_results",selectClass:"mla_ac_over",matchClass:"mla_ac_match",minchars:2,multiple:true,multipleSep:mlaModal.settings.comma+" "})});f.siblings(":first").click(function(){mlaModal.tagBox.getCloud(b("a",this).attr("id"),c);b("a",this).unbind().click(function(){b(this).siblings(".the-tagcloud").toggle();return false});return false});b(".compat-field-"+c+" td",e).on("mouseleave",function(){var k,i=this,h=mlaModal.utility.arrayCleanup(b(".server-tags",i).val()),j=mlaModal.utility.arrayCleanup(b(".the-tags",i).val());if(h===j){return}b(i).css("opacity","0.5");k={id:g,};k[c]=j;wp.media.post(mlaModal.settings.ajaxUpdateCompatAction,k).done(function(m){var n,l,o;for(l in m){if("object"===typeof(m[l]["object-terms"])){if(null!==mlaModal.utility.mlaAttachmentsBrowser){mlaModal.utility.mlaAttachmentsBrowser.updateFilters(l,m[l]["object-terms"])}delete m[l]["object-terms"]}for(o in m[l]){b("#"+o,i).replaceWith(m[l][o])}n=b("#mla-taxonomy-"+l,i);mlaModal.tagBox.quickClicks(n)}b(i).css("opacity","1.0")})});f.on("change",function(h){h.stopPropagation();return false});b(".the-tags, .server-tags .newtag",f).on("change",function(h){h.stopPropagation();return false})}};if(mlaModal.settings.enableDetailsCategory||mlaModal.settings.enableDetailsTag){wp.media.view.AttachmentCompat=wp.media.view.AttachmentCompat.extend({initialize:function(){wp.media.view.AttachmentCompat.__super__.initialize.apply(this,arguments);this.on("ready",function(){mlaModal.utility.hookCompatTaxonomies(this.model.get("id"),this.el)})}})}if(mlaModal.settings.enableDetailsCategory||mlaModal.settings.enableDetailsTag){wp.media.model.Selection=wp.media.model.Selection.extend({initialize:function(){wp.media.model.Selection.__super__.initialize.apply(this,arguments);this.on("selection:reset",function(){mlaModal.cid=null});this.on("selection:unsingle",function(){mlaModal.cid=null});this.on("selection:single",function(c){mlaModal.cid=c.cid});this.on("change:uploading",function(){mlaModal.uploading=true});this.on("change",function(c){var d=false,e;if(mlaModal.uploading&&mlaModal.cid===c.cid){mlaModal.uploading=false;d=true}else{if(false===c.attributes.uploading){e=_.clone(c.changed);delete e.title;delete e.caption;delete e.alt;delete e.description;if(!_.isEmpty(e)){d=true}}}if(true===d){mlaModal.utility.hookCompatTaxonomies(c.get("id"),mlaModal.settings.$el)}})}})}mlaModal.utility.hookCompatTaxonomies=function(f,d){var c,e=null;b(".mla-taxonomy-field .categorydiv",d).each(function(){c=mlaModal.utility.parseTaxonomyId(b(this).attr("id"));if(-1!=mlaModal.settings.enhancedTaxonomies.indexOf(c)){b(".compat-field-"+c+" th",d).click({id:f,currentTaxonomy:c,el:d},function(g){mlaModal.utility.fillCompatTaxonomies(g.data)});b("tr.compat-field-"+c,d).each(function(){if(b(this).hasClass("mla-taxonomy-row")){b(this).show()}else{b(this).remove()}});if(null===e){e=c}}else{b("tr.compat-field-"+c,d).each(function(){if(b(this).hasClass("mla-taxonomy-row")){b(this).remove()}})}});b(".mla-taxonomy-field .tagsdiv",d).each(function(){c=mlaModal.utility.parseTaxonomyId(b(this).attr("id"));if(-1!=mlaModal.settings.enhancedTaxonomies.indexOf(c)){b(".compat-field-"+c+" th",d).click({id:f,currentTaxonomy:c,el:d},function(g){mlaModal.utility.fillCompatTaxonomies(g.data)});b("tr.compat-field-"+c,d).each(function(){if(b(this).hasClass("mla-taxonomy-row")){b(this).show()}else{b(this).remove()}});if(null===e){e=c}}else{b("tr.compat-field-"+c,d).each(function(){if(b(this).hasClass("mla-taxonomy-row")){b(this).remove()}})}});if(mlaModal.settings.enableTermsAutofill&&null!==e){b(".compat-field-"+e+" th",d).click()}};mlaModal.utility.fillCompatTaxonomies=function(g){var d=g.el,f=[],c,e;b(".mla-taxonomy-field .categorydiv",d).each(function(){c=mlaModal.utility.parseTaxonomyId(b(this).attr("id"));f[f.length]=c;e=".compat-field-"+c;if("undefined"===typeof(mlaModal.initialHTML[c])){mlaModal.initialHTML[c]=b(e,d).html()}else{b(e,d).html(mlaModal.initialHTML[c])}b(e+" .categorydiv",d).html(mlaModal.strings.loadingText)});b(".mla-taxonomy-field .tagsdiv",d).each(function(){c=mlaModal.utility.parseTaxonomyId(b(this).attr("id"));f[f.length]=c;e=".compat-field-"+c;if("undefined"===typeof(mlaModal.initialHTML[c])){mlaModal.initialHTML[c]=b(e,d).html()}else{b(e,d).html(mlaModal.initialHTML[c])}b(e+" .tagsdiv",d).html(mlaModal.strings.loadingText)});if(f.length){wp.media.post(mlaModal.settings.ajaxFillCompatAction,{id:g.id,query:f,}).done(function(i){var h,j;for(h in i){j=".compat-field-"+h;b(j,d).html(i[h])}mlaModal.utility.supportCompatTaxonomies(g);b(".compat-field-"+g.currentTaxonomy+" td",d).show()})}};mlaModal.utility.supportCompatTaxonomies=function(e){var d=e.id,c=e.el;if(mlaModal.settings.enableDetailsCategory){b(".mla-taxonomy-field .categorydiv",c).each(function(){var h=b(this),f,i,g,l,j,n,m,k;g=mlaModal.utility.parseTaxonomyId(b(this).attr("id"));l=g+"_tab";j="#mla-"+g;n="#mla-new-"+g;m="#mla-search-"+g;k="#mla-attachments-"+d+"-"+g;if(g=="category"){l="cats"}h.find(".category-tabs").show();b(".compat-field-"+g+" th",c).click(function(){b(this).siblings("td").slideToggle()});h.on("mouseleave",function(){var r,o,q=[],p=h.find(j+"-checklist input:checked");p.each(function(){q[q.length]=b(this).val()});q.sort(function(t,s){return t-s});q=q.join(",");o=h.siblings(k).val();if(o===q){return}h.siblings(k).val(q);h.prop("disabled",true);r={id:d,};r[g]=q;wp.media.post(mlaModal.settings.ajaxUpdateCompatAction,r).done(function(t){var s,u;for(s in t){for(u in t[s]){h.find("#"+u).html(t[s][u])}}h.find(m).val("");h.find(j+"-searcher").addClass("mla-hidden-children");h.prop("disabled",false)})});h.on('change input[type="checkbox"]',function(o){o.stopPropagation();return false});h.find(j+"-tabs a").click(function(){var o=b(this).attr("href");b(this).parent().addClass("tabs").siblings("li").removeClass("tabs");h.find(j+"-tabs").siblings(".tabs-panel").hide();h.find(o).show();b(this).focus();if("#mla-"+g+"-all"==o){deleteUserSetting(l)}else{setUserSetting(l,"pop")}return false});if(getUserSetting(l)){h.find(j+'-tabs a[href="#mla-'+g+'-pop"]').click()}h.find(j+"-add-toggle").click(function(){h.find(j+"-searcher").addClass("mla-hidden-children");h.find(j+"-adder").toggleClass("mla-hidden-children");h.find(j+'-tabs a[href="#mla-'+g+'-all"]').click();h.find(j+"-checklist li").show();h.find(j+"-checklist-pop li").show();if(false===h.find(j+"-adder").hasClass("mla-hidden-children")){h.find(n).val("").removeClass("form-input-tip");h.find(n).focus()}return false});h.find(n).keypress(function(o){if(13===o.keyCode){o.preventDefault();h.find(j+"-add-submit").click()}});h.find(j+"-add-submit").click(function(){h.find(n).focus()});f=function(o){if(!h.find(n).val()){return false}o.data+="&"+h.find(j+"-checklist :checked").serialize();h.prop("disabled",true);return o};i=function(t,q){var p,o=h.find("#new"+g+"_parent");h.prop("disabled",false);if("undefined"!=q.parsed.responses[0]&&(p=q.parsed.responses[0].supplemental.newcat_parent)){o.before(p);o.remove();if(null!==mlaModal.utility.mlaAttachmentsBrowser){mlaModal.utility.mlaAttachmentsBrowser.updateFilters(g,p)}}};h.find(j+"-checklist").wpList({alt:"",response:"mla-"+g+"-ajax-response",addBefore:f,addAfter:i});h.find(j+"-checklist, "+j+"-checklist-pop").on("click",'li.popular-category > label input[type="checkbox"]',function(){var o=b(this),q=o.is(":checked"),p=o.val();if(p&&o.parents("#mla-taxonomy-"+g).length){b("#in-"+g+"-"+p+", #in-popular-"+g+"-"+p).prop("checked",q)}});b.extend(b.expr[":"],{matchTerms:function(q,p,o,r){return(q.textContent||q.innerText||"").toLowerCase().indexOf((o[3]||"").toLowerCase())>=0}});h.find(m).keypress(function(o){if(13===o.keyCode){o.preventDefault();h.find(m).val("");h.find(j+"-searcher").addClass("mla-hidden-children");h.find(j+"-checklist li").show();h.find(j+"-checklist-pop li").show();return}});h.find(m).keyup(function(q){var s,r,t,p,o;if(13===q.keyCode){q.preventDefault();h.find(j+"-search-toggle").focus();return}s=h.find(m).val();r=h.find(j+"-checklist li");t=h.find(j+"-checklist-pop li");if(0<s.length){r.hide();t.hide()}else{r.show();t.show()}p=h.find(j+"-checklist label:matchTerms('"+s+"')");p.closest("li").find("li").andSelf().show();p.parents(j+"-checklist li").show();o=h.find(j+"-checklist-pop label:matchTerms('"+s+"')");o.closest("li").find("li").andSelf().show();o.parents(j+"-checklist li").show()});h.find(j+"-search-toggle").click(function(){h.find(j+"-adder ").addClass("mla-hidden-children");h.find(j+"-searcher").toggleClass("mla-hidden-children");h.find(j+'-tabs a[href="#mla-'+g+'-all"]').click();h.find(j+"-checklist li").show();h.find(j+"-checklist-pop li").show();if(false===h.find(j+"-searcher").hasClass("mla-hidden-children")){h.find(m).val("").removeClass("form-input-tip");h.find(m).focus()}return false})})}if(mlaModal.settings.enableDetailsTag){b(".mla-taxonomy-field .tagsdiv",c).each(function(){var f=mlaModal.utility.parseTaxonomyId(b(this).attr("id"));b(".compat-field-"+f+" th",c).click(function(){b(this).siblings("td").slideToggle()});mlaModal.tagBox.init(d,f,c)})}}}(jQuery));